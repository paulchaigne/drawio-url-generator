<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CSV to draw.io URL Generator</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
</head>
<body>
  <h1>CSV to draw.io URL Generator</h1>
  <input type="file" id="csvFile" accept=".csv" />
  <button onclick="generateUrl()">Generate draw.io Link</button>
  <p id="status"></p>
  <textarea id="result" rows="6" cols="100" readonly></textarea>

  <script>
    function csvToXml(csvText) {
      // Extract metadata from the header comments
      const lines = csvText.trim().split(/\r?\n/);
      let headers = [];
      let dataLines = [];
      let meta = '';
      let inData = false;

      for (let line of lines) {
        if (line.startsWith('##')) continue; // skip visual separators
        if (line.startsWith('#')) {
          meta += line + '\n';
        } else {
          if (!inData) {
            headers = line.split(',');
            inData = true;
          } else {
            dataLines.push(line);
          }
        }
      }

      const csvOnly = [headers.join(',')].concat(dataLines).join('\n');

      // Recreate final text
      return meta + csvOnly;
    }

    function encodeForDrawio(xmlString) {
      const compressed = pako.deflateRaw(xmlString, { to: 'string' });
      const base64 = btoa(
        Array.from(compressed, (byte) => String.fromCharCode(byte)).join('')
      );

      // Make base64 URL safe
      return base64
        .replace(/\+/g, '-')
        .replace(/\//g, '_')
        .replace(/=+$/, '');
    }

    function generateUrl() {
      const fileInput = document.getElementById('csvFile');
      const resultBox = document.getElementById('result');
      const status = document.getElementById('status');

      if (!fileInput.files.length) {
        alert('Please upload a CSV file first.');
        return;
      }

      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          const csvText = e.target.result;
          const wrappedCsv = csvToXml(csvText);

          const xml = `<?xml version="1.0" encoding="UTF-8"?>
<mxfile host="app.diagrams.net">
  <diagram name="Page-1" id="csvimport">
    ${wrappedCsv}
  </diagram>
</mxfile>`;

          const encoded = encodeForDrawio(xml);
          const url = `https://viewer.diagrams.net/?tags=%7B%7D&lightbox=1&highlight=0000ff&edit=_blank&layers=1&nav=1&dark=0#R${encoded}`;

          resultBox.value = url;
          status.textContent = 'URL successfully generated!';
        } catch (err) {
          console.error(err);
          status.textContent = 'Error generating URL.';
          resultBox.value = err.toString();
        }
      };

      reader.readAsText(fileInput.files[0]);
    }
  </script>
</body>
</html>
