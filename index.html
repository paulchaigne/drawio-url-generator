<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CSV to draw.io URL</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 2rem; }
    textarea { width: 100%; height: 300px; margin-bottom: 1rem; }
    input[type="text"] { width: 100%; padding: 0.5rem; margin-top: 1rem; }
    button { padding: 0.5rem 1rem; margin-top: 1rem; }
    .output { margin-top: 1rem; }
  </style>
</head>
<body>
  <h1>CSV to draw.io Diagram Link</h1>
  <p>Paste your draw.io-compatible CSV with directives below:</p>
  <textarea id="csvInput" placeholder="Paste CSV content here..."></textarea>
  <button onclick="generateUrl()">Generate draw.io URL</button>
  <div class="output">
    <p><strong>Resulting draw.io URL:</strong></p>
    <input type="text" id="outputUrl" readonly />
    <p><a id="previewLink" href="#" target="_blank">Open in draw.io</a></p>
  </div>

  <script>
    function generateUrl() {
      const csv = document.getElementById("csvInput").value.trim();

      // Wrap CSV in draw.io import XML
      const xml =
        `<mxfile><diagram name="Page-1">` +
        csvToEncodedXml(csv) +
        `</diagram></mxfile>`;

      // Compress and base64 encode
      const compressed = pako.deflateRaw(xml, { level: 9 });
      const base64 = btoa(String.fromCharCode(...compressed));

      // Assemble final URL
      const url = `https://viewer.diagrams.net/?tags=%7B%7D&lightbox=1&highlight=0000ff&edit=_blank&layers=1&nav=1&dark=0#R${base64}`;

      // Output
      document.getElementById("outputUrl").value = url;
      document.getElementById("previewLink").href = url;
    }

    function csvToEncodedXml(csv) {
      // Escape characters for XML
      const escapeXml = str =>
        str.replace(/&/g, "&amp;")
           .replace(/</g, "&lt;")
           .replace(/>/g, "&gt;")
           .replace(/"/g, "&quot;")
           .replace(/'/g, "&apos;");

      return escapeXml(csv);
    }
  </script>
</body>
</html>
